<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satellite Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI Emoji', 'Apple Color Emoji', 'Noto Color Emoji', sans-serif;
        }
        #map {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        .leaflet-container {
            background: #f0f0f0;
        }

        /* Custom satellite icon styles */
        .custom-satellite-icon {
            background: white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 48px;
            height: 48px;
        }

        /* Pulsing animation for active tracking */
        .custom-satellite-icon::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid #e74c3c;
            border-radius: 50%;
            animation: pulse 2s infinite;
            box-sizing: border-box;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.3);
                opacity: 0;
            }
        }

        /* Direction indicator */
        .direction-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 16px solid #e74c3c;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            transform-origin: center 16px;
        }

        /* Custom control buttons */
        .custom-control-button {
            width: 34px;
            height: 34px;
            background: white;
            border: 2px solid rgba(0,0,0,0.2);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #333;
            transition: all 0.2s;
            text-decoration: none;
            margin-bottom: 1px;
        }

        .custom-control-button:hover {
            background: #f4f4f4;
            border-color: rgba(0,0,0,0.3);
        }

        .custom-control-button:active {
            transform: scale(0.95);
        }

        .leaflet-control-custom-buttons {
            display: flex;
            flex-direction: column;
        }

        /* Coordinate display */
        .coordinate-display {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 1000;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Scale control styling */
        .leaflet-control-scale {
            border: 2px solid #777;
            border-top: none;
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 1px 5px rgba(0,0,0,0.2);
        }

        /* Layer control styling */
        .leaflet-control-layers {
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .leaflet-control-layers-expanded {
            padding: 10px;
            background: rgba(255, 255, 255, 0.95);
        }

        /* Measurement popup */
        .measure-popup {
            font-weight: bold;
            color: #e74c3c;
        }

        /* Loading indicator */
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
            color: #666;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 1000;
        }
    </style>
</head>
<body>
<div id="map">
    <div class="map-loading" id="loadingIndicator">Loading map...</div>
</div>
<div class="coordinate-display" id="coordinateDisplay">
    Lat: <span id="latDisplay">38.4013</span> | Lon: <span id="lonDisplay">34.0286</span> | Zoom: <span id="zoomDisplay">15</span>
</div>
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    var map = null;
    var marker = null;
    var pathLine = null;
    var pathCoordinates = [];
    var currentHeading = 0;
    var measureMode = false;
    var measureLine = null;
    var measurePoints = [];

    function initializeMap() {
        try {
            console.log('Initializing map...');

            // Hide loading indicator
            document.getElementById('loadingIndicator').style.display = 'none';

            // Create map instance
            map = L.map('map', {
                // center: [41.2995, 69.2401],
                center: [38.4013, 34.0286],
                zoom: 15,
                zoomControl: false,
                attributionControl: true
            });

            // Define base layers
            var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 19
            });

            var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '© Esri',
                maxZoom: 19
            });

            var terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenTopoMap',
                maxZoom: 17
            });

            // Add satellite layer as default
            satelliteLayer.addTo(map);

            // Create layer control
            var baseLayers = {
                "Street Map": osmLayer,
                "Satellite": satelliteLayer,
                "Terrain": terrainLayer
            };

            L.control.layers(baseLayers, null, {
                position: 'topright'
            }).addTo(map);

            // Add scale control
            L.control.scale({
                position: 'bottomleft',
                metric: true,
                imperial: false
            }).addTo(map);

            // Add zoom control
            L.control.zoom({
                position: 'topleft'
            }).addTo(map);

            // Create custom control for additional buttons
            var CustomControl = L.Control.extend({
                options: {
                    position: 'topleft'
                },

                onAdd: function(map) {
                    var container = L.DomUtil.create('div', 'leaflet-control-custom-buttons leaflet-bar');

                    // Home button
                    var homeButton = L.DomUtil.create('a', 'custom-control-button', container);
                    homeButton.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18"><path fill="#2c3e50" d="M12 3l10 9h-3v9h-6v-6h-2v6H5v-9H2z"/></svg>';
                    homeButton.title = 'Go to home position';
                    homeButton.href = '#';
                    homeButton.onclick = function(e) {
                        e.preventDefault();
                        map.setView([38.4013, 34.0286], 15);
                        return false;
                    };

                    // Center on marker button
                    var centerButton = L.DomUtil.create('a', 'custom-control-button', container);
                    centerButton.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18"><path fill="#2c3e50" d="M12 2a10 10 0 1 1 0 20 10 10 0 0 1 0-20zm0 2a8 8 0 0 0 0 16 8 8 0 0 0 0-16zm1 4v5h4v2h-6V8h2z"/></svg>';
                    centerButton.title = 'Center on satellite';
                    centerButton.href = '#';
                    centerButton.onclick = function(e) {
                        e.preventDefault();
                        if (marker) {
                            map.setView(marker.getLatLng(), map.getZoom());
                        }
                        return false;
                    };

                    // Clear path button
                    var clearButton = L.DomUtil.create('a', 'custom-control-button', container);
                    clearButton.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18"><path fill="#2c3e50" d="M18.3 5.71L12 12.01 5.71 5.71 4.29 7.13 10.59 13.43 4.29 19.71 5.71 21.13 12 14.83l6.29 6.3 1.42-1.42-6.3-6.3 6.3-6.29z"/></svg>';
                    clearButton.title = 'Clear path';
                    clearButton.href = '#';
                    clearButton.style.fontWeight = 'bold';
                    clearButton.style.fontSize = '20px';
                    clearButton.onclick = function(e) {
                        e.preventDefault();
                        clearPath();
                        return false;
                    };

                    // Measure distance button
                    var measureButton = L.DomUtil.create('a', 'custom-control-button', container);
                    measureButton.innerHTML = '<svg viewBox="0 0 24 24" width="18" height="18"><path fill="#2c3e50" d="M3 16.5V21h4.5l12-12-4.5-4.5-12 12z"/></svg>';
                    measureButton.title = 'Measure distance';
                    measureButton.href = '#';
                    measureButton.onclick = function(e) {
                        e.preventDefault();
                        toggleMeasureMode();
                        return false;
                    };

                    return container;
                }
            });

            map.addControl(new CustomControl());

            // Add coordinate display update
            map.on('mousemove', function(e) {
                document.getElementById('latDisplay').textContent = e.latlng.lat.toFixed(6);
                document.getElementById('lonDisplay').textContent = e.latlng.lng.toFixed(6);
            });

            map.on('zoomend', function() {
                document.getElementById('zoomDisplay').textContent = map.getZoom();
            });

            // Measurement functionality
            map.on('click', function(e) {
                if (!measureMode) return;

                const clickedLatLng = e.latlng;

                const pointMarker = L.circleMarker(clickedLatLng, {
                    radius: 5,
                    color: '#e74c3c',
                    fillColor: '#e74c3c',
                    fillOpacity: 1
                }).addTo(map);

                measurePoints.push(pointMarker);

                const latlngs = measurePoints.map(m => m.getLatLng());

                // Draw or update the measure line
                if (measureLine) {
                    measureLine.setLatLngs(latlngs);
                } else {
                    measureLine = L.polyline(latlngs, {
                        color: '#e74c3c',
                        weight: 2,
                        dashArray: '5, 5'
                    }).addTo(map);
                }

                // Calculate total distance in meters
                let totalDistance = 0;
                for (let i = 1; i < latlngs.length; i++) {
                    totalDistance += latlngs[i - 1].distanceTo(latlngs[i]);
                }

                // Show popup near last clicked point
                L.popup({ className: 'measure-popup' })
                    .setLatLng(clickedLatLng)
                    .setContent('Total Distance: ' + (totalDistance / 1000).toFixed(2) + ' km')
                    .openOn(map);
            });

            // Create custom satellite icon
            var satelliteIcon = L.divIcon({
                className: 'custom-satellite-icon',
                html: `
                    <div style="position: relative; width: 100%; height: 100%;">
                        <div class="direction-arrow" id="direction-arrow"></div>
                        <svg viewBox="0 0 48 48" width="48" height="48" style="position: absolute; top: 0; left: 0;">
                            <!-- Satellite body -->
                            <rect x="16" y="16" width="16" height="16" rx="2" fill="#2c3e50" stroke="#34495e" stroke-width="1"/>

                            <!-- Solar panels -->
                            <rect x="4" y="20" width="10" height="8" rx="1" fill="#3498db" stroke="#2980b9" stroke-width="1"/>
                            <rect x="34" y="20" width="10" height="8" rx="1" fill="#3498db" stroke="#2980b9" stroke-width="1"/>

                            <!-- Panel lines -->
                            <line x1="6" y1="24" x2="12" y2="24" stroke="#2980b9" stroke-width="0.5"/>
                            <line x1="36" y1="24" x2="42" y2="24" stroke="#2980b9" stroke-width="0.5"/>

                            <!-- Antenna -->
                            <circle cx="24" cy="24" r="3" fill="#e74c3c" stroke="#c0392b" stroke-width="1"/>

                            <!-- Signal waves -->
                            <circle cx="24" cy="24" r="6" fill="none" stroke="#e74c3c" stroke-width="0.5" opacity="0.5"/>
                            <circle cx="24" cy="24" r="9" fill="none" stroke="#e74c3c" stroke-width="0.5" opacity="0.3"/>
                        </svg>
                    </div>
                `,
                iconSize: [48, 48],
                iconAnchor: [24, 24],
                popupAnchor: [0, -24]
            });

            // Add marker
            marker = L.marker([38.4013, 34.0286], {
                icon: satelliteIcon
            }).addTo(map);

            // Add popup to marker
            marker.bindPopup('<b>Satellite Position</b><br>Click for details');

            // Add path line
            pathLine = L.polyline([], {
                color: '#3498db',
                weight: 4,
                opacity: 0.7,
                smoothFactor: 1
            }).addTo(map);

            // Force resize after a delay
            setTimeout(function() {
                map.invalidateSize();
            }, 100);

            console.log('Map initialized successfully');
            return true;

        } catch (error) {
            console.error('Error initializing map:', error);
            document.getElementById('loadingIndicator').textContent = 'Error loading map';
            return false;
        }
    }

    function toggleMeasureMode() {
        measureMode = !measureMode;

        if (!measureMode) {
            if (measureLine) {
                map.removeLayer(measureLine);
                measureLine = null;
            }

            measurePoints.forEach(marker => map.removeLayer(marker));
            measurePoints = [];

            // Remove existing popups if any
            map.closePopup();
        }

        map.getContainer().style.cursor = measureMode ? 'crosshair' : '';
    }

    // Update marker position
    function updatePosition(lat, lon, heading) {
        if (!map || !marker || !pathLine) {
            console.error('Map not initialized');
            return;
        }

        try {
            var newLatLng = L.latLng(lat, lon);

            // Update marker position
            marker.setLatLng(newLatLng);

            // Update heading/direction
            if (heading !== undefined && heading !== null) {
                currentHeading = heading;
                var arrow = document.getElementById('direction-arrow');
                if (arrow) {
                    arrow.style.transform = 'translateX(-50%) rotate(' + heading + 'deg)';
                }
            }

            // Add to path
            pathCoordinates.push([lat, lon]);
            pathLine.setLatLngs(pathCoordinates);

            // Update popup content
            marker.setPopupContent(
                '<b>Satellite Position</b><br>' +
                'Lat: ' + lat.toFixed(6) + '<br>' +
                'Lon: ' + lon.toFixed(6) + '<br>' +
                'Heading: ' + (currentHeading || 0).toFixed(0) + '°<br>' +
                'Time: ' + new Date().toLocaleTimeString()
            );

            // Update coordinate display
            document.getElementById('latDisplay').textContent = lat.toFixed(6);
            document.getElementById('lonDisplay').textContent = lon.toFixed(6);

        } catch (error) {
            console.error('Error updating position:', error);
        }
    }

    // Clear the path
    function clearPath() {
        if (pathLine) {
            pathCoordinates = [];
            pathLine.setLatLngs([]);
        }
        console.log('Path cleared');
    }

    // Center map on marker
    function centerMap() {
        if (map && marker) {
            map.setView(marker.getLatLng(), map.getZoom());
        }
    }

    // Handle window resize
    window.addEventListener('resize', function() {
        if (map) {
            map.invalidateSize();
        }
    });

    // Initialize map when page loads
    window.addEventListener('load', function() {
        initializeMap();
    });

    // Also try to initialize immediately
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initializeMap();
    }

    // Make functions available globally for JavaFX
    window.updatePosition = updatePosition;
    window.clearPath = clearPath;
    window.centerMap = centerMap;
</script>
</body>
</html>